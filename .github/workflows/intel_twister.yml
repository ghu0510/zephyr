name: 'Run Twister - Intel'
on:
  pull_request:
    branches:
      - main-intel
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  run_twister:
    defaults:
      run:
        shell: bash
    runs-on: uzdo128
    container:
      image: amr-registry.caas.intel.com/zephyrproject/sdk-docker-intel:main
      options: -v/opt/toolchains:/opt/toolchains
      env:
        TOKEN: ${{ secrets.ZEPHYR_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        subset: [1, 2, 3, 4]
        toolchain: [gcc, xcc]
        include:
          - toolchain: 'xcc'
            platform: 'intel_adsp_ace15_mtpm'
            toolchain_ver: 'RG-2019.12-linux'
            xtensa_core: 'ace10_LX7HiFi4'
            variant: 'xcc'
            subset: 1
          - toolchain: 'xcc'
            platform: 'intel_adsp_cavs15'
            toolchain_ver: 'RG-2017.8-linux'
            xtensa_core: 'X4H3I16w2D48w3a_2017_8'
            variant: 'xcc'
            subset: 2
          - toolchain: 'xcc'
            platform: 'intel_adsp_cavs18'
            toolchain_ver: 'RG-2017.8-linux'
            xtensa_core: 'X6H3CNL_2017_8'
            variant: 'xcc'
            subset: 3
          - toolchain: 'xcc'
            platform: 'intel_adsp_cavs25'
            toolchain_ver: 'RG-2017.8-linux'
            xtensa_core: 'cavs2x_LX6HiFi3_2017_8'
            variant: 'xcc'
            subset: 4
    timeout-minutes: 60
    env:
      TWISTER_OPTS: "-v -M -x=USE_CCACHE=0 --inline-logs --retry-failed 3 --retry-interval 60 --force-color --no-skipped-report --integration -j 64"
    steps:
      - name: Clean
        run: |
          shopt -s dotglob
          rm -rf *
      - name: Checkout
        uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0
      - name: Set Creds for internal repos
        run: |
          touch $HOME/.git-credentials
          touch $HOME/.gitconfig
          git config --global user.email "sys_tmbuild@intel.com"
          git config --global user.name "Github Builder CI"
          git config --global credential.helper 'store --file=$HOME/.git-credentials'
          west init -l . || true
          for r in `west  list -f {url} | grep intel-innersource | sed 's#https://##'`; do
            echo -e "https://$TOKEN:$TOKEN@$r" >> $HOME/.git-credentials
          done
          # debug
          cat $HOME/.git-credentials
          git config --global --add safe.directory ${PWD}

      - name: Environment Setup
        run: |
          west config --global update.narrow true
          west update
          west forall -c 'git reset --hard HEAD'

      - name: Build
        run: |

          if [ ${{ matrix.toolchain }} == 'gcc' ]; then

            export ZEPHYR_TOOLCHAIN_VARIANT=zephyr
            ./scripts/twister \
              ${TWISTER_OPTS} \
              --subset  ${{matrix.subset}}/4 \
              -T tests

          elif [ ${{ matrix.toolchain }} == 'xcc' ]; then

            export ZEPHYR_TOOLCHAIN_VARIANT=${{ matrix.variant }}
            export XTENSA_TOOLCHAIN_PATH=/opt/toolchains/xcc/install/tools
            export XTENSA_CORE=${{ matrix.xtensa_core }}
            export TOOLCHAIN_VER=${{ matrix.toolchain_ver }}
            export XTENSA_BUILDS_DIR=/opt/toolchains/xcc/install/builds

            ./scripts/twister \
              ${TWISTER_OPTS} \
              --retry-build-errors \
              --quarantine-list .github/workflows/xcc-twister-quarantine.yml \
              --build-only \
              --disable-warnings-as-errors \
              -p ${{ matrix.platform }} \
              -T tests -e cmsis_dsp
          fi


      - name: Save Artifacts
        if: failure() || success()
        uses: actions/upload-artifact@v2
        with:
          name: twister_log_${{ matrix.subset }}_of_${{ strategy.job-total }}
          path: |
            twister-out/twister.log
            twister-out/twister.xml
            twister-out/twister.json
          retention-days: 7

  publish-test-results:
    name: 'Publish Test Results'
    needs: [run_twister]
    runs-on: fmos-ubuntu-latest
    continue-on-error: true
    if: always()
    steps:
      - run: env
      - name: Clean
        run: |
          rm -rf artifacts
      - name: Download Artifacts
        uses: actions/download-artifact@v2
        with:
          path: artifacts
      - name: Publish Unit Test Results
        uses: intel-innersource/os.rtos.zephyr.devops.ci/actions/results-publisher@main
        with:
          files: 'artifacts/**/twister.xml'
          check_name: 'Test Results using twister'
          comment_mode: off
          compare_to_earlier_commit: false

  # "Intel-CI-Passed" is our exit job that matches branch-protection status-check
  # settings for PR workflow. Make sure all required tests are prereqs to this job.
  # For this build workflow, no actions are taken by Intel-CI-Passed, just status
  # echo.
  Intel-CI-Passed:
    needs: [run_twister]
    runs-on: fmos-ubuntu-latest
    steps:
      - name: Post run steps
        run: echo "Intel-CI-Passed"
